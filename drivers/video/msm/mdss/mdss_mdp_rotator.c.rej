--- drivers/video/msm/mdss/mdss_mdp_rotator.c
+++ drivers/video/msm/mdss/mdss_mdp_rotator.c
@@ -179,6 +179,7 @@
 					       head);
 
 			rc = mdss_mdp_rotator_busy_wait(tmp);
+			mdss_mdp_smp_release(tmp->pipe);
 			list_del(&tmp->head);
 			if (rc) {
 				pr_err("no pipe attached to session=%d\n",
@@ -440,6 +441,7 @@
 	struct mdss_mdp_rotator_session *rot = NULL;
 	struct mdss_mdp_format_params *fmt;
 	u32 bwc_enabled;
+	bool format_changed = false;
 	int ret = 0;
 
 	mutex_lock(&rotator_lock);
@@ -473,6 +475,16 @@
 			ret = -ENODEV;
 			goto rot_err;
 		}
+
+		if (work_pending(&rot->commit_work)) {
+			mutex_unlock(&rotator_lock);
+			flush_work(&rot->commit_work);
+			mutex_lock(&rotator_lock);
+		}
+
+		if (rot->format != fmt->format)
+			format_changed = true;
+
 	} else {
 		pr_err("invalid rotator session id=%x\n", req->id);
 		ret = -EINVAL;
@@ -592,6 +604,12 @@
 
 	rot->params_changed++;
 
+	/* If the format changed, release the smp alloc */
+	if (format_changed && rot->pipe) {
+		mdss_mdp_rotator_busy_wait(rot);
+		mdss_mdp_smp_release(rot->pipe);
+	}
+
 	ret = __mdss_mdp_rotator_pipe_reserve(rot);
 	if (!ret && rot->next)
 		ret = __mdss_mdp_rotator_pipe_reserve(rot->next);
@@ -629,6 +647,12 @@
 
 	rot_pipe = rot->pipe;
 	if (rot_pipe) {
+		if (work_pending(&rot->commit_work)) {
+			mutex_unlock(&rotator_lock);
+			cancel_work_sync(&rot->commit_work);
+			mutex_lock(&rotator_lock);
+		}
+
 		mdss_mdp_rotator_busy_wait(rot);
 		list_del(&rot->head);
 	}
